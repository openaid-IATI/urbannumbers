function OipaCompareSelection(e){this.left=[];this.left.cities=[];this.left.countries=[];this.left.regions=[];this.right=[];this.right.cities=[];this.right.countries=[];this.right.regions=[];this.indicators=[];this.url=new OipaUrl(this)}function OipaIndicatorMap(){this.indicatordata={};this.active_years={};this.init=function(){this.selected_year=2015;$("#map-slider-tooltip div").html(this.selected_year);$("#map-slider-tooltip").val(this.selected_year);$("#year-"+this.selected_year).addClass("active")};this.refresh=function(e){if(!e){this.clear_circles();var t=this.get_url();this.get_data(t)}else{this.show_data_on_map(e);this.draw_available_data_blocks();this.selected_year=this.get_first_available_year();this.move_slider_to_available_year();this.refresh_circles(this.selected_year)}};this.get_url=function(){var e=get_parameters_from_selection(this.selection.regions),t=get_parameters_from_selection(this.selection.countries),n=get_parameters_from_selection(this.selection.cities),r=get_parameters_from_selection(this.selection.indicators);return search_url+"indicator-data/?format=json&countries__in="+t+"&regions__in="+e+"&cities__in="+n+"&indicators__in="+r};this.get_data=function(e){var t=this;$.support.cors=!0;if(window.XDomainRequest){var n=new XDomainRequest;n.open("get",e);n.onprogress=function(){};n.ontimeout=function(){};n.onerror=function(){};n.onload=function(){var e=$.parseJSON(n.responseText);if(e===null||typeof e=="undefined"){e=$.parseJSON(e.firstChild.textContent);t.refresh(e)}};setTimeout(function(){n.send()},0)}else $.ajax({type:"GET",url:e,contentType:"application/json",dataType:"json",success:function(e){t.refresh(e)}})};this.show_data_on_map=function(e){var t=this.map,n=this.circles,r=this.vistype;n.indicators={};n.locations={};this.active_years={};var i=this.active_years,s=["#2B5A70","DarkGreen","Orange","Pink","Purple"],o=-1;$.each(e,function(e,u){o++;$.each(u.locs,function(e,a){if(a.longitude==null||a.latitude==null)return!0;try{n.indicators[u.indicator]={};n.indicators[u.indicator].description=u.indicator_friendly;n.indicators[u.indicator].type_data=u.type_data;n.indicators[u.indicator].max_value=u.max_value;n.locations[e]||(n.locations[e]={});n.locations[e][u.indicator]||(n.locations[e][u.indicator]={});n.locations[e][u.indicator].years=a.years;$.each(a.years,function(e,t){i[e]=e});if(r=="markers")var f=L.marker([a.latitude,a.longitude]).addTo(t);else if(r=="value-markers")var f=L.marker([a.latitude,a.longitude],{icon:L.divIcon({className:"country-marker-icon",html:"null",iconSize:[36,44],iconAnchor:[18,34]})}).addTo(t);else var f=L.circle(new L.LatLng(a.latitude,a.longitude),1,{color:s[o],weight:"2",fillColor:s[o],fillOpacity:.7}).setRadius(1e3).addTo(t);n.locations[e][u.indicator].circle=f;n.locations[e].countryname=a.name}catch(l){console.log(l)}})})};this.delete_markers=function(){for(var e=0;e<this.markers.length;e++)this.map.removeLayer(this.markers[e])};this.refresh_circles=function(e){var t=this.circles,n=5e12,r=e,i=this.vistype;t.locations!==undefined&&$.each(t.locations,function(e,s){var o="<h4>"+s.countryname+"</h4>";$.each(t.indicators,function(e,t){if(s[e]!==undefined){var n=s[e].years[r];if(n===undefined)n="Not available for "+r;else{t.type_data=="1000"&&(n=comma_formatted(n*1e3+"."));t.type_data=="p"&&(n+="%")}o+="<p>"+t.description+": "+n+"</p>"}});if(i=="value-markers")$.each(t.indicators,function(e,t){if(s[e]!==undefined){var n=s[e].circle,i=s[e].years[r];i!==undefined&&n.setIcon(L.divIcon({className:"country-marker-icon",html:i,iconSize:[140,44],iconAnchor:[70,34]}));n.bindPopup(o)}});else if(i=="markers")$.each(t.indicators,function(e,t){if(s[e]!==undefined){var n=s[e].circle;n.bindPopup(o)}});else try{$.each(t.indicators,function(e,t){if(s[e]!==undefined){var i=s[e].circle,u=s[e].years[r];if(u!==undefined){circle_radius=Math.round(Math.sqrt(Math.round(n/t.max_value)*u/Math.PI));i.setRadius(circle_radius)}i.bindPopup(o)}})}catch(u){console.log(u)}})};this.draw_available_data_blocks=function(e){$(".slider-year").removeClass("slider-active");$.each(this.active_years,function(e,t){$("#year-"+e).addClass("slider-active")})};this.move_slider_to_available_year=function(){var e=this.selected_year;$("#map-slider-tooltip").val(e);$("#map-slider-tooltip div").text(e.toString());$(".slider-year").removeClass("active");$("#year-"+e.toString()).addClass("active")};this.get_first_available_year=function(){var e=this.active_years;if(this.selected_year in e)return this.selected_year;for(var t=this.selected_year;t>1949;t--)if(t in e)return t;for(var t=this.selected_year;t<2100;t++)if(t in e)return t;return null};this.clear_circles=function(){var e=this.circles,t=this.map;e.locations!==undefined&&$.each(e.locations,function(n,r){$.each(e.indicators,function(e,n){r[e]!==undefined&&t.removeLayer(r[e].circle)})})}}function OipaIndicatorFilters(){this.validate_selection=function(){if(Oipa.pageType=="indicators"){if(this.selection.indicators.length==0){$(".filter-error-msg").text("Please select at least one indicator.");return!1}$(".filter-error-msg").text("");return!0}return!0};this.get_url=function(e,t){if(t)var n=search_url+"indicator-filter-options/?format=json"+t;else var n=search_url+"indicator-filter-options/?format=json"+"&indicators__in="+get_parameters_from_selection(this.selection.indicators)+"&regions__in="+get_parameters_from_selection(this.selection.regions)+"&countries__in="+get_parameters_from_selection(this.selection.countries)+"&cities__in="+get_parameters_from_selection(this.selection.cities);return n};this.process_filter_options=function(e){var t=4;$.each(e,function(e,n){if(!$.isEmptyObject(n)){$.inArray(e,["indicators","regions"])>-1?t=2:t=4;filter.create_filter_attributes(n,t,e)}});this.initialize_filters()};this.create_indicator_filter_attributes=function(e,t){var n="",r="",i=6,s=[];for(var o in e)s.push([o,e[o]]);s.sort(function(e,t){var n=e[1].name.toString().toLowerCase(),r=t[1].name.toString().toLowerCase();return n<r?-1:n>r?1:0});var u={},a={rural:"Rural area",city_core:"City core",urban_area:"Urban area","City core":"city core",sub_urban_area:"Sub-urban area",sub_urban:"Sub-urban area",total:"Total"};for(var f=0;f<s.length;f++){var l=s[f][1].name,c=s[f][1].category;t==4&&l.length>32?l=l.substr(0,28)+"...":t==3&&l.length>40&&(l=l.substr(0,36)+"...");c in u||(u[c]=[]);var h=s[f][1].name.split(" – ");if(h.length>1){var p=s[f][0],d=h[0],v=new Object;v[p]=h[1];for(var m=f;m<s.length;m++){var g=s[m][1].name.split(" – ");if(g.length>1&&g[0]==d){v[s[m][0]]={filter_name:g[1],display_name:s[m][1].name};f=m}}var y='<div class="filter-indicator-type-dropdown"><a href="#" class="filter-indicator-type-text"><span class="urbnnrs-arrow"></span>'+d+'</a><div class="filter-indicator-type-inner">';$.each(v,function(e,t){y+='<div class="checkbox"><label><input type="checkbox" selection_type="'+t.filter_name+'" value="'+e+'" id="'+e+'" name="'+t.display_name+'" />'+t.filter_name+"</label></div>"});y+="</div></div>"}else var y='<div class="checkbox"><label><input type="checkbox" value="'+s[f][0]+'" id="'+s[f][1].name.toString().replace(/ /g,"").replace(",","").replace("&","").replace("%","perc")+'" name="'+s[f][1].name+'" />'+l+" </label></div>";u[c].push(y)}r+="<ul>";$.each(u,function(e,t){var i=Math.ceil(t.length/2),s=e.toString().toLowerCase().replace(/ /g,"").replace(",","").replace("&","").replace("%","perc");n+='<div class="row filter-page filter-page-'+s+'">';n+='<div class="col-md-6 col-sm-6 col-xs-12">';$.each(t,function(e,t){e==i&&(n+='</div><div class="col-md-6 col-sm-6 col-xs-12">');n+=t});n+="</div></div>";r+='<li><a href="#" class="indicator-category-button" name="'+s+'">'+e+"</a></li>"});r+="</ul>";$("#indicators-pagination").html(r);$("#indicators-filters").html(n);this.load_indicator_paginate_listeners();this.update_selection_after_filter_load()};this.load_indicator_paginate_listeners=function(){$("#indicators-pagination li a").click(function(e){e.preventDefault();$("#indicators-pagination li").removeClass("active");$(this).parent().addClass("active");var t=$(this).attr("name");$("#indicators-filters .filter-page").hide();$(".filter-page-"+t).show()});$("#indicators-pagination li a:first").click();$(".filter-indicator-type-text").click(function(e){e.preventDefault();$(this).closest(".filter-indicator-type-dropdown").children(".filter-indicator-type-inner").toggle(500)})}}function OipaCompareFilters(){this.update_selection_object=function(){this.selection.left.countries=this.get_checked_by_filter("left-countries");var e=this.get_checked_by_filter("left-cities");e.length>0&&(this.selection.left.cities=e);this.selection.right.countries=this.get_checked_by_filter("right-countries");var t=this.get_checked_by_filter("right-cities");t.length>0&&(this.selection.right.cities=t);this.selection.indicators=this.get_checked_by_filter("indicators")};this.get_selection_object=function(){var e=new OipaCompareSelection;e.left.countries=this.get_checked_by_filter("left-countries");e.left.cities=this.get_checked_by_filter("left-cities");e.right.countries=this.get_checked_by_filter("right-countries");e.right.cities=this.get_checked_by_filter("right-cities");e.indicators=this.get_checked_by_filter("indicators");return e};this.get_url=function(e,t){if(t)var n=search_url+"indicator-filter-options/?format=json&adm_division__in=city"+t;else var n=search_url+"indicator-filter-options/?format=json"+"&indicators__in="+get_parameters_from_selection(this.selection.indicators);return n};this.process_filter_options=function(e){var t=4,n=this;this.create_filter_attributes(e.countries,t,"left-countries");this.create_filter_attributes(e.countries,t,"right-countries");this.create_filter_attributes(e.cities,t,"left-cities");this.create_filter_attributes(e.cities,t,"right-cities");this.create_filter_attributes(e.indicators,2,"indicators");if(this.firstLoad===!0){firstLoad=!1;OipaCompare.randomize()}this.initialize_filters()}}function slide_tooltip(){var e=$("#map-slider-tooltip").val();$("#map-slider-tooltip div").text(e);map.refresh_circles(e);$(".slider-year").removeClass("active");$("#year-"+e).addClass("active")}var OipaCompare={item1:null,item2:null,refresh_state:0,refresh_comparison:function(){leftmap.map.setView(this.item1.latlng,10);rightmap.map.setView(this.item2.latlng,10);$("#compare-left-title").text(this.item1.name);$("#compare-right-title").text(this.item2.name)},randomize:function(){var e=[];$("#left-cities-filters input").each(function(){e.push($(this).val())});var t=[];$("#right-cities-filters input").each(function(){t.push($(this).val())});var n=get_random_city_within_selection(e),r=get_random_city_within_selection(t,n),i=leftmap.set_city(n);this.item1=i;Oipa.mainSelection.left.cities=[{id:i.id,name:i.name}];var s=rightmap.set_city(r);this.item2=s;Oipa.mainSelection.right.cities=[{id:s.id,name:s.name}];filter.save(!0)},create_visualisations:function(){var e=new OipaIndicatorSelection;e.indicators.push({id:"cpi_environment_index",name:"Environment Sustainability Index",type:"City prosperity"});e.indicators.push({id:"cpi_infrastructure_index",name:"Infrastructure Development Index",type:"City prosperity"});e.indicators.push({id:"cpi_productivity_index",name:"Productivity Index",type:"City prosperity"});e.indicators.push({id:"cpi_quality_of_live_index",name:"Quality of Life Index",type:"City prosperity"});e.indicators.push({id:"cpi_equity_index",name:"Equity/Social Inclusion Index",type:"City prosperity"});e.indicators.push({id:"cpi_composite_street_connectivity_index",name:"Composite Street Connectivity Index"});e.cities.push({id:filter.selection.left.cities[0].id,name:filter.selection.left.cities[0].name});e.cities.push({id:filter.selection.right.cities[0].id,name:filter.selection.right.cities[0].name});var t=new OipaRadarChart;t.indicator="cpi_combined_"+OipaCompare.item1.id+"_"+OipaCompare.item2.id;t.chartwrapper="#visualisation-block-wrapper";t.name="City prosperity";t.selection=e;t.init();Oipa.visualisations.push(t);e.indicators=[];e.indicators.push({id:"urban_population_cities",name:"Urban population"});var n=new OipaColumnChart;n.indicator="urban_population_cities_"+OipaCompare.item1.id+"_"+OipaCompare.item2.id;n.chartwrapper="#visualisation-block-wrapper";n.name="Urban population";n.selection=e;n.init();Oipa.visualisations.push(n);e.indicators=[];e.indicators.push({id:"urban_population_share_national",name:"Share in national urban population"});var n=new OipaColumnChart;n.indicator="urban_population_share_national_"+OipaCompare.item1.id+"_"+OipaCompare.item2.id;n.chartwrapper="#visualisation-block-wrapper";n.name="Share in national urban population";n.selection=e;n.init();Oipa.visualisations.push(n);e.indicators=[];e.indicators.push({id:"avg_annual_rate_change_percentage_urban",name:"Annual urban population change %"});var n=new OipaColumnChart;n.indicator="avg_annual_rate_change_percentage_urban_"+OipaCompare.item1.id+"_"+OipaCompare.item2.id;n.chartwrapper="#visualisation-block-wrapper";n.name="Annual urban population change %";n.selection=e;n.init();Oipa.visualisations.push(n);e.indicators=[];e.indicators.push({id:"land_area",name:"Land area"});var n=new OipaColumnChart;n.indicator="land_area_"+OipaCompare.item1.id+"_"+OipaCompare.item2.id;n.chartwrapper="#visualisation-block-wrapper";n.name="Land area";n.selection=e;n.init();Oipa.visualisations.push(n);e.indicators=[];e.indicators.push({id:"population_estimate",name:"Population estimate"});var n=new OipaColumnChart;n.indicator="population_estimate_"+OipaCompare.item1.id+"_"+OipaCompare.item2.id;n.chartwrapper="#visualisation-block-wrapper";n.name="Population estimate";n.selection=e;n.init();Oipa.visualisations.push(n);e.indicators=[];e.indicators.push({id:"urban_agglomeration_density",name:"Urban agglomeration_density"});var n=new OipaColumnChart;n.indicator="urban_agglomeration_density_"+OipaCompare.item1.id+"_"+OipaCompare.item2.id;n.chartwrapper="#visualisation-block-wrapper";n.name="Urban agglomeration density";n.selection=e;n.init();Oipa.visualisations.push(n);e.indicators=[];e.indicators.push({id:"intersection_density_city_core",name:"Intersection density - City core"});e.indicators.push({id:"intersection_density_sub_urban_area",name:"Intersection density - Sub urban area"});e.indicators.push({id:"intersection_density_total",name:"Intersection density - Total"});var n=new OipaColumnChart;n.indicator="intersection_density_"+OipaCompare.item1.id+"_"+OipaCompare.item2.id;n.chartwrapper="#visualisation-block-wrapper";n.name="Intersection density";n.selection=e;n.init();Oipa.visualisations.push(n);e.indicators=[];e.indicators.push({id:"proportion_land_allocated_to_street_sub_urban_area",name:"Proportion of land allocated to street - City core"});e.indicators.push({id:"proportion_land_allocated_to_street_city_core",name:"Proportion of land allocated to street - Sub urban area"});e.indicators.push({id:"proportion_land_allocated_to_street_total",name:"Proportion of land allocated to street - Total"});var n=new OipaColumnChart;n.indicator="proportion_land_allocated_to_street_"+OipaCompare.item1.id+"_"+OipaCompare.item2.id;n.chartwrapper="#visualisation-block-wrapper";n.name="Proportion of land allocated to street";n.selection=e;n.init();Oipa.visualisations.push(n);e.indicators=[];e.indicators.push({id:"street_density_city_core",name:"Street density - City core"});e.indicators.push({id:"street_density_sub_urban_area",name:"Street density - Sub urban area"});e.indicators.push({id:"street_density_total",name:"Street density - Total"});var n=new OipaColumnChart;n.indicator="street_density"+OipaCompare.item1.id+"_"+OipaCompare.item2.id;n.chartwrapper="#visualisation-block-wrapper";n.name="Street density";n.selection=e;n.init();Oipa.visualisations.push(n)}};OipaIndicatorMap.prototype=new OipaMap;OipaIndicatorFilters.prototype=new OipaFilters;OipaCompareFilters.prototype=new OipaIndicatorFilters;$("#map-slider-tooltip").noUiSlider({range:[1950,2050],handles:1,start:2e3,step:1,slide:slide_tooltip});$(".slider-year").click(function(){var e=$(this).attr("id"),t=e.replace("year-","");map.refresh_circles(t);$("#map-slider-tooltip").val(parseInt(t));$("#map-slider-tooltip div").text(t);$(".slider-year").removeClass("active");$(this).addClass("active")});