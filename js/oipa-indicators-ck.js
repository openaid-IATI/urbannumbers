function OipaCompareSelection(e){this.left=[];this.left.cities=[];this.left.countries=[];this.left.regions=[];this.right=[];this.right.cities=[];this.right.countries=[];this.right.regions=[];this.indicators=[];e&&(this.url=new OipaUrl)}function OipaIndicatorMap(){this.active_years={};this.init=function(){this.selected_year=2015;$("#map-slider-tooltip div").html(this.selected_year);$("#map-slider-tooltip").val(this.selected_year);$("#year-"+this.selected_year).addClass("active")};this.refresh=function(e){if(!e){this.clear_circles();var t=this.get_url();this.get_data(t)}else{this.show_data_on_map(e);this.draw_available_data_blocks();this.selected_year=this.get_first_available_year();this.move_slider_to_available_year();this.refresh_circles(this.selected_year)}};this.get_url=function(){var e=get_parameters_from_selection(this.selection.regions),t=get_parameters_from_selection(this.selection.countries),n=get_parameters_from_selection(this.selection.cities),r=get_parameters_from_selection(this.selection.indicators);return search_url+"indicator-data/?format=json&countries__in="+t+"&regions__in="+e+"&cities__in="+n+"&indicators__in="+r};this.show_data_on_map=function(e){var t=this.map,n=this.circles,r=this.vistype;n.indicators={};n.countries={};this.active_years={};var i=this.active_years,s=["#2B5A70","DarkGreen","Orange","Pink","Purple"],o=-1;$.each(e,function(e,u){o++;var a=null;Object.keys(u.cities).length>0?a=u.cities:a=u.countries;$.each(a,function(e,a){if(a.longitude==null||a.latitude==null)return!0;try{n.indicators[u.indicator]={};n.indicators[u.indicator].description=u.indicator_friendly;n.indicators[u.indicator].type_data=u.type_data;n.indicators[u.indicator].max_value=u.max_value;n.countries[e]||(n.countries[e]={});n.countries[e][u.indicator]||(n.countries[e][u.indicator]={});n.countries[e][u.indicator].years=a.years;$.each(a.years,function(e,t){i[e]=e});if(r=="markers")var f=L.marker([a.latitude,a.longitude]).addTo(t);else if(r=="value-markers")var f=L.marker([a.latitude,a.longitude],{icon:L.divIcon({className:"country-marker-icon",html:"null",iconSize:[36,44],iconAnchor:[18,34]})}).addTo(t);else var f=L.circle(new L.LatLng(a.latitude,a.longitude),1,{color:s[o],weight:"5",fillColor:s[o],fillOpacity:.7}).setRadius(1).addTo(t);n.countries[e][u.indicator].circle=f;n.countries[e].countryname=a.name}catch(l){console.log(l)}})})};this.delete_markers=function(){for(var e=0;e<this.markers.length;e++)this.map.removeLayer(this.markers[e])};this.refresh_circles=function(e){var t=this.circles,n=5e11,r=e,i=this.vistype;t.countries!==undefined&&$.each(t.countries,function(e,s){var o="<h4>"+s.countryname+"</h4>";$.each(t.indicators,function(e,t){if(s[e]!==undefined){var n=s[e].years[r];if(n===undefined)n="Not available";else{t.type_data=="1000"&&(n=comma_formatted(n*1e3+"."));t.type_data=="p"&&(n+="%")}o+="<p>"+t.description+": "+n+"</p>"}});i=="value-markers"?$.each(t.indicators,function(e,t){if(s[e]!==undefined){var n=s[e].circle,i=s[e].years[r];i!==undefined&&n.setIcon(L.divIcon({className:"country-marker-icon",html:i,iconSize:[140,44],iconAnchor:[70,34]}));n.bindPopup(o)}}):i=="markers"?$.each(t.indicators,function(e,t){circle.bindPopup(o)}):$.each(t.indicators,function(e,t){if(s[e]!==undefined){var i=s[e].circle,u=s[e].years[r];if(u!==undefined){circle_radius=Math.round(Math.sqrt(Math.round(n/t.max_value)*u/Math.PI));i.setRadius(circle_radius)}i.bindPopup(o)}})})};this.draw_available_data_blocks=function(e){$(".slider-year").removeClass("slider-active");$.each(this.active_years,function(e,t){$("#year-"+e).addClass("slider-active")})};this.move_slider_to_available_year=function(){var e=this.selected_year;$("#map-slider-tooltip").val(e);$("#map-slider-tooltip div").text(e.toString());$(".slider-year").removeClass("active");$("#year-"+e.toString()).addClass("active")};this.get_first_available_year=function(){var e=this.active_years;if(this.selected_year in e)return this.selected_year;for(var t=this.selected_year;t>1949;t--)if(t in e)return t;for(var t=this.selected_year;t<2100;t++)if(t in e)return t;return null};this.clear_circles=function(){var e=this.circles,t=this.map;e.countries!==undefined&&$.each(e.countries,function(n,r){$.each(e.indicators,function(e,n){r[e]!==undefined&&t.removeLayer(r[e].circle)})})}}function OipaCompareFilters(){this.update_selection_object=function(){this.selection.left.countries=this.get_checked_by_filter("left-countries");this.selection.left.cities=this.get_checked_by_filter("left-cities");this.selection.right.countries=this.get_checked_by_filter("right-countries");this.selection.right.cities=this.get_checked_by_filter("right-cities");this.selection.indicators=this.get_checked_by_filter("indicators")};this.get_selection_object=function(){var e=new OipaCompareSelection;e.left.countries=this.get_checked_by_filter("left-countries");e.left.cities=this.get_checked_by_filter("left-cities");e.right.countries=this.get_checked_by_filter("right-countries");e.right.cities=this.get_checked_by_filter("right-cities");e.indicators=this.get_checked_by_filter("indicators");return e};this.get_url=function(e,t){if(t)var n=search_url+"indicator-city-filter-options/?format=json"+t;else var n=search_url+"indicator-city-filter-options/?format=json"+"&indicators__in="+get_parameters_from_selection(this.selection.indicators);return n};this.process_filter_options=function(e){var t=4,n=this;this.create_filter_attributes(e.countries,t,"left-countries");this.create_filter_attributes(e.countries,t,"right-countries");this.create_filter_attributes(e.cities,t,"left-cities");this.create_filter_attributes(e.cities,t,"right-cities");this.create_filter_attributes(e.indicators,2,"indicators");if(this.firstLoad===!0){firstLoad=!1;OipaCompare.randomize()}this.initialize_filters()}}function OipaIndicatorFilters(){this.get_url=function(e,t){if(t)var n=search_url+"indicator-filter-options/?format=json"+t;else var n=search_url+"indicator-filter-options/?format=json"+"&indicators__in="+get_parameters_from_selection(this.selection.indicators)+"&regions__in="+get_parameters_from_selection(this.selection.regions)+"&countries__in="+get_parameters_from_selection(this.selection.countries)+"&cities__in="+get_parameters_from_selection(this.selection.cities);return n};this.process_filter_options=function(e){var t=4;$.each(e,function(e,n){if(!$.isEmptyObject(n)){$.inArray(e,["indicators","regions"])>-1?t=2:t=4;filter.create_filter_attributes(n,t,e)}});this.initialize_filters()}}function slide_tooltip(){var e=$("#map-slider-tooltip").val();$("#map-slider-tooltip div").text(e);map.refresh_circles(e);$(".slider-year").removeClass("active");$("#year-"+e).addClass("active")}var OipaCompare={item1:null,item2:null,refresh_state:0,refresh_comparison:function(){leftmap.map.setView(this.item1.latlng,10);rightmap.map.setView(this.item2.latlng,10);$("#compare-left-title").text(this.item1.name);$("#compare-right-title").text(this.item2.name)},randomize:function(){var e=[];$("#left-cities-filters input").each(function(){e.push($(this).val())});var t=[];$("#right-cities-filters input").each(function(){t.push($(this).val())});var n=get_random_city_within_selection(e),r=get_random_city_within_selection(t,n),i=leftmap.set_city(n);this.item1=i;var s=rightmap.set_city(r);this.item2=s}};OipaIndicatorMap.prototype=new OipaMap;OipaCompareFilters.prototype=new OipaFilters;OipaIndicatorFilters.prototype=new OipaFilters;$("#map-slider-tooltip").noUiSlider({range:[1950,2050],handles:1,start:2e3,step:1,slide:slide_tooltip});$(".slider-year").click(function(){var e=$(this).attr("id"),t=e.replace("year-","");map.refresh_circles(t);$("#map-slider-tooltip").val(parseInt(t));$("#map-slider-tooltip div").text(t);$(".slider-year").removeClass("active");$(this).addClass("active")});